<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Êù°‰æã„ÉÜ„Ç≠„Çπ„Éà„Éì„É•„Éº„Ç¢ - Áµ±ÂêàÂàÜÊûêÁâà</title>
  <link rel="icon" href="data:," />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <style>
    :root {
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;
  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;
    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);
    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
  }
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
}

body {
  margin: 0;
  padding: 0;
}

.app-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background-color: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
  padding: var(--space-20) var(--space-32);
  box-shadow: var(--shadow-sm);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: var(--space-16);
}

.header h1 {
  font-size: var(--font-size-3xl);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text);
  letter-spacing: var(--letter-spacing-tight);
}

.header-tabs {
  display: flex;
  gap: var(--space-8);
}

.tab-btn {
  padding: var(--space-8) var(--space-16);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  background-color: var(--color-surface);
  color: var(--color-text);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
}

.tab-btn:hover {
  background-color: var(--color-secondary-hover);
}

.tab-btn.active {
  background-color: var(--color-primary);
  color: var(--color-btn-primary-text);
  border-color: var(--color-primary);
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: var(--space-24);
  gap: var(--space-24);
}

@media (min-width: 1024px) {
  .main-content {
    flex-direction: row;
  }
}

.filter-section {
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
  gap: var(--space-16);
}

@media (min-width: 1024px) {
  .filter-section {
    width: 420px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
    position: sticky;
    top: var(--space-24);
  }
}

.filter-card {
  background-color: var(--color-surface);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-lg);
  padding: var(--space-16);
  box-shadow: var(--shadow-sm);
}

.filter-card h2 {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-12);
  color: var(--color-text);
}

.button-grid {
  display: grid;
  gap: var(--space-6);
}

.button-grid.municipalities {
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
}

.button-grid.codings {
  grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
}

.button-grid.analysis-filters {
  grid-template-columns: 1fr;
}

.filter-btn {
  padding: var(--space-6) var(--space-10);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  background-color: var(--color-surface);
  color: var(--color-text);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.filter-btn:hover {
  background-color: var(--color-secondary-hover);
  border-color: var(--color-primary);
}

.filter-btn:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.filter-btn.selected {
  background-color: var(--color-primary);
  color: var(--color-btn-primary-text);
  border-color: var(--color-primary);
  font-weight: var(--font-weight-semibold);
}

.filter-btn.selected:hover {
  background-color: var(--color-primary-hover);
}

.reset-btn {
  width: 100%;
  padding: var(--space-10) var(--space-16);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  background-color: var(--color-surface);
  color: var(--color-text);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
}

.reset-btn:hover {
  background-color: var(--color-secondary-hover);
}

.reset-btn:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.display-section {
  flex: 1;
  min-width: 0;
}

.view-container {
  display: none;
}

.view-container.active {
  display: block;
}

.stats-bar {
  background-color: var(--color-bg-1);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-base);
  padding: var(--space-12) var(--space-16);
  margin-bottom: var(--space-16);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.paragraphs-container {
  display: flex;
  flex-direction: column;
  gap: var(--space-16);
}

.paragraph-card {
  background-color: var(--color-surface);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-lg);
  padding: var(--space-16);
  box-shadow: var(--shadow-sm);
  transition: box-shadow var(--duration-normal) var(--ease-standard);
}

.paragraph-card:hover {
  box-shadow: var(--shadow-md);
}

.paragraph-header {
  background-color: var(--color-bg-2);
  padding: var(--space-8) var(--space-12);
  border-radius: var(--radius-sm);
  margin-bottom: var(--space-12);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--color-text);
}

.paragraph-meta {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-8);
  margin-bottom: var(--space-8);
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
}

.municipality-badge {
  display: inline-flex;
  align-items: center;
  gap: var(--space-4);
  padding: var(--space-4) var(--space-8);
  background-color: var(--color-bg-3);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
}

.analysis-badges {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-6);
  margin-top: var(--space-8);
}

.badge {
  padding: var(--space-4) var(--space-8);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
  white-space: nowrap;
}

.badge.regulation-type {
  background-color: var(--color-bg-1);
  color: var(--color-text);
}

.badge.zone-type {
  background-color: var(--color-bg-5);
  color: var(--color-text);
}

.badge.strictness {
  color: white;
}

.badge.strictness.very-strict {
  background-color: rgba(220, 38, 38, 0.8);
}

.badge.strictness.strict {
  background-color: rgba(234, 88, 12, 0.8);
}

.badge.strictness.standard {
  background-color: rgba(250, 204, 21, 0.7);
  color: var(--color-text);
}

.badge.strictness.lenient {
  background-color: rgba(34, 197, 94, 0.7);
  color: var(--color-text);
}

.badge.process {
  background-color: var(--color-bg-6);
  color: var(--color-text);
}

.badge.editable {
  cursor: pointer;
  position: relative;
  transition: transform var(--duration-fast) var(--ease-standard);
}

.badge.editable:hover {
  transform: scale(1.05);
  opacity: 0.9;
}

.badge.editable::after {
  content: '‚úèÔ∏è';
  font-size: 10px;
  margin-left: 4px;
  opacity: 0.6;
}

.edit-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  margin-top: 4px;
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  box-shadow: var(--shadow-lg);
  padding: var(--space-8);
  z-index: 1000;
  min-width: 200px;
  display: none;
}

.edit-dropdown.show {
  display: block;
}

.edit-dropdown label {
  display: block;
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-4);
  font-weight: var(--font-weight-medium);
}

.edit-dropdown select {
  width: 100%;
  padding: var(--space-6) var(--space-8);
  font-size: var(--font-size-sm);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  background-color: var(--color-surface);
  color: var(--color-text);
  margin-bottom: var(--space-8);
  cursor: pointer;
}

.edit-dropdown select:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: var(--focus-ring);
}

.edit-dropdown-buttons {
  display: flex;
  gap: var(--space-6);
  margin-top: var(--space-8);
}

.edit-dropdown button {
  flex: 1;
  padding: var(--space-6) var(--space-8);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
}

.edit-dropdown button.save-btn {
  background-color: var(--color-primary);
  color: var(--color-btn-primary-text);
  border-color: var(--color-primary);
}

.edit-dropdown button.save-btn:hover {
  background-color: var(--color-primary-hover);
}

.edit-dropdown button.cancel-btn {
  background-color: var(--color-surface);
  color: var(--color-text);
}

.edit-dropdown button.cancel-btn:hover {
  background-color: var(--color-secondary-hover);
}

.paragraph-text {
  font-size: var(--font-size-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  white-space: pre-wrap;
  word-wrap: break-word;
}

.highlight {
  background-color: rgba(245, 158, 11, 0.3);
  padding: var(--space-1) var(--space-2);
  border-radius: var(--radius-sm);
  font-weight: var(--font-weight-medium);
}

/* Dashboard styles */
.dashboard-container {
  display: grid;
  gap: var(--space-20);
}

.dashboard-section {
  background-color: var(--color-surface);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-lg);
  padding: var(--space-20);
  box-shadow: var(--shadow-sm);
}

.dashboard-section h2 {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-16);
  color: var(--color-text);
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--space-16);
}

.chart-container {
  position: relative;
  height: 300px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-12);
}

.stat-card {
  background-color: var(--color-bg-1);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-base);
  padding: var(--space-12);
  text-align: center;
}

.stat-value {
  font-size: var(--font-size-3xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-primary);
}

.stat-label {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-top: var(--space-4);
}

.loading {
  text-align: center;
  padding: var(--space-32);
  font-size: var(--font-size-lg);
  color: var(--color-text-secondary);
}

.error {
  background-color: rgba(var(--color-error-rgb), 0.1);
  border: 1px solid var(--color-error);
  border-radius: var(--radius-base);
  padding: var(--space-16);
  color: var(--color-error);
  margin: var(--space-16);
}

.no-results {
  text-align: center;
  padding: var(--space-32);
  font-size: var(--font-size-base);
  color: var(--color-text-secondary);
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: var(--color-secondary);
  border-radius: var(--radius-sm);
}

::-webkit-scrollbar-thumb {
  background: var(--color-border);
  border-radius: var(--radius-sm);
}

::-webkit-scrollbar-thumb:hover {
  background: var(--color-text-secondary);
}
  </style>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <div class="header-content">
        <h1>Êù°‰æã„ÉÜ„Ç≠„Çπ„Éà„Éì„É•„Éº„Ç¢ - Áµ±ÂêàÂàÜÊûêÁâà</h1>
        <div class="header-tabs">
          <button class="tab-btn active" data-view="text">„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫</button>
          <button class="tab-btn" data-view="dashboard">Áµ±Ë®à„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</button>
        </div>
      </div>
    </header>
    
    <main class="main-content">
      <aside class="filter-section">
        <div class="filter-card">
          <h2>üè¢ Ëá™Ê≤ª‰Ωì„ÇíÈÅ∏Êäû</h2>
          <div id="municipalities" class="button-grid municipalities"></div>
        </div>
        
        <div class="filter-card">
          <h2>üìã „Ç≥„Éº„Éá„Ç£„É≥„Ç∞„ÇíÈÅ∏Êäû</h2>
          <div id="codings" class="button-grid codings"></div>
        </div>
        
        <div class="filter-card">
          <h2>üîç ÂàÜÊûê„Éï„Ç£„É´„Çø</h2>
          
          <h3 style="font-size: 14px; margin: 12px 0 8px; color: var(--color-text-secondary);">Ë¶èÂà∂„Çø„Ç§„Éó</h3>
          <div id="regulationTypes" class="button-grid analysis-filters"></div>
          
          <h3 style="font-size: 14px; margin: 12px 0 8px; color: var(--color-text-secondary);">Âå∫ÂüüÈ°ûÂûã</h3>
          <div id="zoneTypes" class="button-grid analysis-filters"></div>
          
          <h3 style="font-size: 14px; margin: 12px 0 8px; color: var(--color-text-secondary);">Âé≥Ê†ºÂ∫¶„É¨„Éô„É´</h3>
          <div id="strictnessLevels" class="button-grid analysis-filters"></div>
          
          <h3 style="font-size: 14px; margin: 12px 0 8px; color: var(--color-text-secondary);">„Éó„É≠„Çª„ÇπÈáçË¶ñÂ∫¶</h3>
          <div id="processTypes" class="button-grid analysis-filters"></div>
        </div>
        
        <button id="resetBtn" class="reset-btn">üîÑ „Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà</button>
      </aside>
      
      <section class="display-section">
        <!-- Text View -->
        <div id="textView" class="view-container active">
          <div id="stats" class="stats-bar"></div>
          <div id="paragraphs" class="paragraphs-container"></div>
        </div>
        
        <!-- Dashboard View -->
        <div id="dashboardView" class="view-container">
          <div class="dashboard-container">
            <div class="dashboard-section">
              <h2>üìä ÂÖ®‰ΩìÁµ±Ë®à</h2>
              <div class="stats-grid" id="overallStats"></div>
            </div>
            
            <div class="dashboard-section">
              <h2>üìà ÂàÜÂ∏É„Ç∞„É©„Éï</h2>
              <div class="dashboard-grid">
                <div class="chart-container">
                  <canvas id="regulationChart"></canvas>
                </div>
                <div class="chart-container">
                  <canvas id="zoneChart"></canvas>
                </div>
                <div class="chart-container">
                  <canvas id="strictnessChart"></canvas>
                </div>
                <div class="chart-container">
                  <canvas id="processChart"></canvas>
                </div>
              </div>
            </div>
            
            <div class="dashboard-section">
              <h2>üéØ „Çπ„Ç≥„Ç¢ÂàÜÊûê</h2>
              <div class="dashboard-grid">
                <div class="chart-container">
                  <canvas id="scatterStrictnessResident"></canvas>
                </div>
                <div class="chart-container">
                  <canvas id="scatterStrictnessProcedure"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    let indexData = {};
    let allParagraphs = []; // ÁèæÂú®Ë™≠„ÅøËæº„Çì„Åß„ÅÑ„ÇãËá™Ê≤ª‰Ωì„ÅÆÊÆµËêΩ„Éá„Éº„Çø
    let municipalities = [];
    let codingTypes = [];
    let municipalityInfo = {};
    let statistics = {};
    let selectedMunicipality = null;
    let selectedCodes = [];
    let selectedRegulationType = null;
    let selectedZoneType = null;
    let selectedStrictnessLevel = null;
    let selectedProcessType = null;
    let currentView = 'text';
    let charts = {};

    // „Éá„Éº„ÇøÂèñÂæó
    async function fetchIndexData() {
      const response = await fetch('data/index.json?t=' + new Date().getTime());
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return await response.json();
    }

    async function fetchMunicipalityData(municipalityName) {
      if (!municipalityName) {
        allParagraphs = [];
        return [];
      }
      const response = await fetch(`data/municipalities/${encodeURIComponent(municipalityName)}.json?t=${new Date().getTime()}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      allParagraphs = Array.isArray(data) ? data : (data.paragraphs || []);
      return allParagraphs;
    }

    // ÂàùÊúüÂåñ
    async function init() {
      try {
        showLoading('„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...');
        indexData = await fetchIndexData();
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíË®≠ÂÆö
        municipalities = indexData.municipalities || [];
        codingTypes = indexData.coding_types || [];
        municipalityInfo = indexData.municipality_info || {};
        statistics = indexData.statistics || {};
        
        initializeUI();
        updateDisplay(); // ÂàùÊúüÁä∂ÊÖã„Åß„ÅØ‰Ωï„ÇÇË°®Á§∫„Åó„Å™„ÅÑ
        setupEventListeners();
        setupTabSwitching();
        
      } catch (error) {
        console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
        showError('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇdata/index.json „ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      } finally {
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„ÇíÊ∂à„Åô
        const loadingEl = document.querySelector('.loading');
        if (loadingEl) loadingEl.remove();
      }
    }
    
    // UI„ÇíÂàùÊúüÂåñ
    function initializeUI() {
      // Ëá™Ê≤ª‰Ωì„Éú„Çø„É≥„ÇíÁîüÊàê
      const municipalityContainer = document.getElementById('municipalities');
      municipalityContainer.innerHTML = ''; // Clear existing
      municipalities.forEach(mun => {
        const btn = document.createElement('button');
        btn.textContent = mun;
        btn.className = 'filter-btn';
        btn.setAttribute('data-municipality', mun);
        btn.addEventListener('click', () => selectMunicipality(mun, btn));
        municipalityContainer.appendChild(btn);
      });

      // „Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Éú„Çø„É≥„ÇíÁîüÊàê
      const codingContainer = document.getElementById('codings');
      codingContainer.innerHTML = ''; // Clear existing
      codingTypes.forEach(code => {
        const btn = document.createElement('button');
        btn.textContent = code;
        btn.className = 'filter-btn';
        btn.setAttribute('data-coding', code);
        btn.addEventListener('click', () => toggleCoding(code, btn));
        codingContainer.appendChild(btn);
      });

      // ÂàÜÊûê„Éï„Ç£„É´„Çø„ÇíÁîüÊàê
      initializeAnalysisFilters();

      // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥
      document.getElementById('resetBtn').addEventListener('click', resetFilters);
    }

    // ÂàÜÊûê„Éï„Ç£„É´„Çø„ÇíÂàùÊúüÂåñ
    function initializeAnalysisFilters() {
      // Ë¶èÂà∂„Çø„Ç§„Éó
      const regulationTypes = Object.keys(statistics['Ë¶èÂà∂„Çø„Ç§„ÉóÂàÜÂ∏É'] || {});
      const regulationContainer = document.getElementById('regulationTypes');
      regulationContainer.innerHTML = ''; // Clear existing
      regulationTypes.forEach(type => {
        const btn = createAnalysisFilterButton(type, () => {
          toggleAnalysisFilter('regulation', type, btn);
        });
        regulationContainer.appendChild(btn);
      });

      // Âå∫ÂüüÈ°ûÂûã
      const zoneTypes = Object.keys(statistics['Âå∫ÂüüÈ°ûÂûãÂàÜÂ∏É'] || {});
      const zoneContainer = document.getElementById('zoneTypes');
      zoneContainer.innerHTML = ''; // Clear existing
      zoneTypes.forEach(type => {
        const btn = createAnalysisFilterButton(type, () => {
          toggleAnalysisFilter('zone', type, btn);
        });
        zoneContainer.appendChild(btn);
      });

      // Âé≥Ê†ºÂ∫¶„É¨„Éô„É´
      const strictnessLevels = ['ÈùûÂ∏∏„Å´Âé≥Ê†º', 'Âé≥Ê†º', 'Ê®ôÊ∫ñ', 'Á∑©„ÇÑ„Åã'];
      const strictnessContainer = document.getElementById('strictnessLevels');
      strictnessContainer.innerHTML = ''; // Clear existing
      strictnessLevels.forEach(level => {
        const btn = createAnalysisFilterButton(level, () => {
          toggleAnalysisFilter('strictness', level, btn);
        });
        strictnessContainer.appendChild(btn);
      });

      // „Éó„É≠„Çª„ÇπÈáçË¶ñÂ∫¶
      const processTypes = Object.keys(statistics['„Éó„É≠„Çª„ÇπÈáçË¶ñÂ∫¶ÂàÜÂ∏É'] || {});
      const processContainer = document.getElementById('processTypes');
      processContainer.innerHTML = ''; // Clear existing
      processTypes.forEach(type => {
        const btn = createAnalysisFilterButton(type, () => {
          toggleAnalysisFilter('process', type, btn);
        });
        processContainer.appendChild(btn);
      });
    }

    function createAnalysisFilterButton(text, onClick) {
      const btn = document.createElement('button');
      btn.textContent = text;
      btn.className = 'filter-btn';
      btn.addEventListener('click', onClick);
      return btn;
    }

    function toggleAnalysisFilter(filterType, value, btnElement) {
      const filterMap = {
        'regulation': 'selectedRegulationType',
        'zone': 'selectedZoneType',
        'strictness': 'selectedStrictnessLevel',
        'process': 'selectedProcessType'
      };
      
      const varName = filterMap[filterType];
      const currentValue = window[varName];
      
      // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™„ÅÆ‰ªñ„ÅÆ„Éú„Çø„É≥„ÇíËß£Èô§
      btnElement.parentElement.querySelectorAll('.filter-btn.selected').forEach(b => {
        b.classList.remove('selected');
      });
      
      if (currentValue === value) {
        window[varName] = null;
      } else {
        window[varName] = value;
        btnElement.classList.add('selected');
      }
      
      updateDisplay();
    }

    // Ëá™Ê≤ª‰Ωì„ÇíÈÅ∏Êäû
    async function selectMunicipality(mun, btnElement) {
      if (selectedMunicipality === mun) {
        selectedMunicipality = null;
        allParagraphs = [];
        btnElement.classList.remove('selected');
        updateDisplay();
      } else {
        document.querySelectorAll('[data-municipality].selected').forEach(b => {
          b.classList.remove('selected');
        });
        selectedMunicipality = mun;
        btnElement.classList.add('selected');
        
        try {
          showLoading(`„Äå${mun}„Äç„ÅÆ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...`);
          await fetchMunicipalityData(mun); // „Åì„ÅÆÂá¶ÁêÜ„ÅåÁµÇ„Çè„Çã„ÅÆ„ÇíÂæÖ„Å§
          updateDisplay(); // ÂæÖ„Å£„ÅüÂæå„Å´„ÄÅË°®Á§∫„ÇíÊõ¥Êñ∞„Åô„Çã
        } catch (error) {
          console.error(`Ëá™Ê≤ª‰Ωì„Éá„Éº„ÇøË™≠Ëæº„Ç®„É©„Éº (${mun}):`, error);
          showError(`„Äå${mun}„Äç„ÅÆ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ`);
        } finally {
           const loadingEl = document.querySelector('.loading');
           if (loadingEl) loadingEl.remove();
        }
      }
    }

    // „Ç≥„Éº„Éá„Ç£„É≥„Ç∞„ÇíÈÅ∏Êäû/Ëß£Èô§
    function toggleCoding(code, btnElement) {
      const index = selectedCodes.indexOf(code);
      if (index > -1) {
        selectedCodes.splice(index, 1);
        btnElement.classList.remove('selected');
      } else {
        selectedCodes.push(code);
        btnElement.classList.add('selected');
      }
      updateDisplay();
    }

    // „Éï„Ç£„É´„Çø„Çí„É™„Çª„ÉÉ„Éà
    function resetFilters() {
      selectedMunicipality = null;
      allParagraphs = [];
      selectedCodes = [];
      selectedRegulationType = null;
      selectedZoneType = null;
      selectedStrictnessLevel = null;
      selectedProcessType = null;
      
      document.querySelectorAll('.filter-btn.selected').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      updateDisplay();
    }

    // Ë°®Á§∫„ÇíÊõ¥Êñ∞
    function updateDisplay() {
      // ÂàÜÊûê„Éï„Ç£„É´„Çø„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åæ„ÅöËá™Ê≤ª‰Ωì„É™„Çπ„Éà„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
      if (selectedRegulationType || selectedZoneType || selectedStrictnessLevel || selectedProcessType) {
        filterAndDisplayMunicipalities();
      } else {
        // „Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞„ÄÅ„Åô„Åπ„Å¶„ÅÆËá™Ê≤ª‰Ωì„Éú„Çø„É≥„ÇíË°®Á§∫
        document.querySelectorAll('#municipalities .filter-btn').forEach(btn => {
            btn.style.display = '';
        });
      }

      const filtered = filterParagraphs();
      displayParagraphs(filtered);
    }

    function filterAndDisplayMunicipalities() {
        const validMunicipalities = Object.keys(municipalityInfo).filter(mun => {
          const info = municipalityInfo[mun];
          if (!info) return false;
          if (selectedRegulationType && info?.regulation_type !== selectedRegulationType) return false;
          if (selectedZoneType && info?.area_type !== selectedZoneType) return false;
          if (selectedStrictnessLevel && info?.strictness_absolute !== selectedStrictnessLevel) return false;
          if (selectedProcessType && info?.process_emphasis !== selectedProcessType) return false;
          return true;
        });

        const validMunSet = new Set(validMunicipalities);

        document.querySelectorAll('#municipalities .filter-btn').forEach(btn => {
            const mun = btn.dataset.municipality;
            if (validMunSet.has(mun)) {
                btn.style.display = '';
            } else {
                btn.style.display = 'none';
            }
        });

        // ÈÅ∏Êäû‰∏≠„ÅÆËá™Ê≤ª‰Ωì„Åå„Éï„Ç£„É´„ÇøÂ§ñ„Å´„Å™„Å£„ÅüÂ†¥Âêà„ÄÅÈÅ∏Êäû„ÇíËß£Èô§
        if (selectedMunicipality && !validMunSet.has(selectedMunicipality)) {
            selectedMunicipality = null;
            allParagraphs = [];
            document.querySelectorAll('[data-municipality].selected').forEach(b => {
                b.classList.remove('selected');
            });
        }
    }


    // ÊÆµËêΩ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
    function filterParagraphs() {
      // Ëá™Ê≤ª‰Ωì„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇË°®Á§∫„Åó„Å™„ÅÑ
      if (!selectedMunicipality) {
        return [];
      }
      
      let filtered = allParagraphs;
      
      // „Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Åß„Éï„Ç£„É´„ÇøÔºàANDÊù°‰ª∂Ôºâ
      if (selectedCodes.length > 0) {
        filtered = filtered.filter(p => {
          return selectedCodes.every(code => p.codes && p.codes.includes(code));
        });
      }
      
      return filtered;
    }

    // ÊÆµËêΩ„ÇíË°®Á§∫
    function displayParagraphs(paragraphs) {
      const container = document.getElementById('paragraphs');
      const statsBar = document.getElementById('stats');
      
      // Áµ±Ë®àÊÉÖÂ†±„ÇíË°®Á§∫
      let statsText = `Ë°®Á§∫‰ª∂Êï∞: ${paragraphs.length}‰ª∂`;
      if (selectedMunicipality) {
        statsText += ` | Ëá™Ê≤ª‰Ωì: ${selectedMunicipality}`;
      } else {
        statsText = 'Ëá™Ê≤ª‰Ωì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
      }
      if (selectedRegulationType) {
        statsText += ` | Ë¶èÂà∂: ${selectedRegulationType}`;
      }
      if (selectedZoneType) {
        statsText += ` | Âå∫Âüü: ${selectedZoneType}`;
      }
      if (selectedStrictnessLevel) {
        statsText += ` | Âé≥Ê†ºÂ∫¶: ${selectedStrictnessLevel}`;
      }
      if (selectedProcessType) {
        statsText += ` | „Éó„É≠„Çª„Çπ: ${selectedProcessType}`;
      }
      if (selectedCodes.length > 0) {
        statsText += ` | „Ç≥„Éº„Éá„Ç£„É≥„Ç∞: ${selectedCodes.join(', ')}`;
      }
      statsBar.textContent = statsText;
      
      container.innerHTML = '';
      
      if (!selectedMunicipality) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = 'Â∑¶„ÅÆ„É°„Éã„É•„Éº„Åã„ÇâËá™Ê≤ª‰Ωì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
        container.appendChild(noResults);
        return;
      }

      if (paragraphs.length === 0) {
        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = 'Ë©≤ÂΩì„Åô„ÇãÊÆµËêΩ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü';
        container.appendChild(noResults);
        return;
      }
      
      paragraphs.forEach(para => {
        const card = document.createElement('div');
        card.className = 'paragraph-card';
        
        // „Éò„ÉÉ„ÉÄ„ÉºÈÉ®ÂàÜ
        const header = document.createElement('div');
        header.className = 'paragraph-header';
        const codes = para.codes && para.codes.length > 0 ? para.codes.join(', ') : '„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Å™„Åó';
        const danNumber = para.dan_number ?? para.dan ?? '-';
        header.textContent = `[${para.h5}-${danNumber}] „Ç≥„Éº„Éá„Ç£„É≥„Ç∞: ${codes}`;
        card.appendChild(header);
        
        // „É°„ÇøÊÉÖÂ†±
        const meta = document.createElement('div');
        meta.className = 'paragraph-meta';
        
        if (para.municipality) {
          const munBadge = document.createElement('div');
          munBadge.className = 'municipality-badge';
          munBadge.textContent = `üè¢ ${para.municipality}`;
          meta.appendChild(munBadge);
        }
        if (para.year) {
          const yearSpan = document.createElement('span');
          yearSpan.textContent = `Âπ¥: ${para.year}`;
          meta.appendChild(yearSpan);
        }
        if (para.category) {
          const catSpan = document.createElement('span');
          catSpan.textContent = `Âå∫ÂàÜ: ${para.category}`;
          meta.appendChild(catSpan);
        }
        
        card.appendChild(meta);
        
        // ÂàÜÊûê„Éê„ÉÉ„Ç∏„ÇíËøΩÂä†
        const munInfo = municipalityInfo[para.municipality];
        if (munInfo) {
          const analysisBadges = document.createElement('div');
          analysisBadges.className = 'analysis-badges';
          
          const regulationValue = munInfo.regulation_type || 'Êú™Ë®≠ÂÆö';
          const regBadge = createEditableBadge(
            'badge regulation-type',
            regulationValue,
            para.municipality,
            'regulation_type',
            Object.keys(statistics['Ë¶èÂà∂„Çø„Ç§„ÉóÂàÜÂ∏É'] || {}),
            'Ë¶èÂà∂„Çø„Ç§„Éó'
          );
          analysisBadges.appendChild(regBadge);
          
          const zoneValue = munInfo.area_type || 'Êú™Ë®≠ÂÆö';
          const zoneBadge = createEditableBadge(
            'badge zone-type',
            zoneValue,
            para.municipality,
            'area_type',
            Object.keys(statistics['Âå∫ÂüüÈ°ûÂûãÂàÜÂ∏É'] || {}),
            'Âå∫ÂüüÈ°ûÂûã'
          );
          analysisBadges.appendChild(zoneBadge);
          
          const strictnessValue = munInfo.strictness_absolute || 'Êú™Ë®≠ÂÆö';
          const strictBadge = createEditableBadge(
            'badge strictness ' + getStrictnessClass(strictnessValue),
            `Âé≥Ê†ºÂ∫¶: ${strictnessValue}`,
            para.municipality,
            'strictness_absolute',
            ['ÈùûÂ∏∏„Å´Âé≥Ê†º', 'Âé≥Ê†º', 'Ê®ôÊ∫ñ', 'Á∑©„ÇÑ„Åã'],
            'Âé≥Ê†ºÂ∫¶„É¨„Éô„É´'
          );
          analysisBadges.appendChild(strictBadge);
          
          const processValue = munInfo.process_emphasis || 'Êú™Ë®≠ÂÆö';
          const procBadge = createEditableBadge(
            'badge process',
            processValue,
            para.municipality,
            'process_emphasis',
            Object.keys(statistics['„Éó„É≠„Çª„ÇπÈáçË¶ñÂ∫¶ÂàÜÂ∏É'] || {}),
            '„Éó„É≠„Çª„ÇπÈáçË¶ñÂ∫¶'
          );
          analysisBadges.appendChild(procBadge);
          
          card.appendChild(analysisBadges);
        }
        
        // Êú¨Êñá
        const text = document.createElement('div');
        text.className = 'paragraph-text';
        text.innerHTML = highlightText(para.text, para.codes || []);
        card.appendChild(text);
        
        container.appendChild(card);
      });
    }

    // „Ç§„Éô„É≥„ÉàÂßîË≠≤„ÅÆ„Åü„ÇÅ„ÅÆ„É™„Çπ„Éä„Éº„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
    function setupEventListeners() {
      const paragraphsContainer = document.getElementById('paragraphs');
      paragraphsContainer.addEventListener('click', (e) => {
        const badge = e.target.closest('.editable');
        if (badge) {
          e.stopPropagation();
          const { municipality, field, options, label } = badge.dataset;
          showEditDropdown(badge, municipality, field, JSON.parse(options), label || field);
        }
      });
    }

    function getStrictnessClass(level) {
      const map = {
        'ÈùûÂ∏∏„Å´Âé≥Ê†º': 'very-strict',
        'Âé≥Ê†º': 'strict',
        'Ê®ôÊ∫ñ': 'standard',
        'Á∑©„ÇÑ„Åã': 'lenient'
      };
      return map[level] || 'standard';
    }

    // Á∑®ÈõÜÂèØËÉΩ„Å™„Éê„ÉÉ„Ç∏„Çí‰ΩúÊàê
    function createEditableBadge(className, text, municipality, field, options, displayLabel) {
      const badge = document.createElement('span');
      badge.className = className + ' editable';
      badge.textContent = text;
      
      // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆ‰ª£„Çè„Çä„Å´dataÂ±ûÊÄß„Çí‰ΩøÁî®
      badge.dataset.municipality = municipality;
      badge.dataset.field = field;
      badge.dataset.options = JSON.stringify(options);
      if (displayLabel) {
        badge.dataset.label = displayLabel;
      }
      
      return badge;
    }

    // Á∑®ÈõÜ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíË°®Á§∫
    function showEditDropdown(badgeElement, municipality, field, options, displayLabel) {
      // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
      console.log('showEditDropdown called:', { municipality, field, options, currentValue: municipalityInfo[municipality]?.[field] });
      
      // Êó¢Â≠ò„ÅÆ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÇíÈñâ„Åò„Çã
      document.querySelectorAll('.edit-dropdown').forEach(d => d.remove());
      
      // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
      if (!municipalityInfo[municipality]) {
        console.error(`Municipality not found: ${municipality}`);
        showToast(`Ëá™Ê≤ª‰ΩìÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${municipality}`, 'error');
        return;
      }
      
      if (!options || options.length === 0) {
        console.error(`No options provided for field: ${field}`);
        showToast(`ÈÅ∏ÊäûËÇ¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì: ${field}`, 'error');
        return;
      }
      
      const dropdown = document.createElement('div');
      dropdown.className = 'edit-dropdown show';
      
      // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ÂÜÖ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„Çí‰ºùÊí≠„Åï„Åõ„Å™„ÅÑ
      dropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      
      const label = document.createElement('label');
      const labelText = displayLabel || field;
      label.textContent = `${labelText}„ÇíÁ∑®ÈõÜ:`;
      dropdown.appendChild(label);
      
      const select = document.createElement('select');
      const currentValue = municipalityInfo[municipality][field];
      
      console.log('Creating select options:', options);
      
      // select„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„Çí‰ºùÊí≠„Åï„Åõ„Å™„ÅÑ
      select.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      
      select.addEventListener('change', (e) => {
        e.stopPropagation();
      });
      
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        if (option === currentValue) {
          opt.selected = true;
        }
        select.appendChild(opt);
      });
      dropdown.appendChild(select);
      
      const buttons = document.createElement('div');
      buttons.className = 'edit-dropdown-buttons';
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.textContent = '‰øùÂ≠ò';
      saveBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const newValue = select.value;
        console.log('Save clicked:', { municipality, field, newValue });
        saveMunicipalityEdit(municipality, field, newValue, badgeElement, labelText);
        dropdown.remove();
      });
      buttons.appendChild(saveBtn);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'cancel-btn';
      cancelBtn.textContent = '„Ç≠„É£„É≥„Çª„É´';
      cancelBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log('Cancel clicked');
        dropdown.remove();
      });
      buttons.appendChild(cancelBtn);
      
      dropdown.appendChild(buttons);
      badgeElement.appendChild(dropdown);
      
      // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„ÇãÔºà„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Å®„Éê„ÉÉ„Ç∏‰ª•Â§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥ÂêàÔºâ
      setTimeout(() => {
        const closeDropdown = (e) => {
          if (!dropdown.contains(e.target) && !badgeElement.contains(e.target)) {
            dropdown.remove();
            document.removeEventListener('click', closeDropdown);
          }
        };
        document.addEventListener('click', closeDropdown);
      }, 100);
    }

    // Ëá™Ê≤ª‰ΩìÊÉÖÂ†±„ÅÆÁ∑®ÈõÜ„Çí‰øùÂ≠ò
    async function saveMunicipalityEdit(municipality, field, newValue, badgeElement, displayLabel = null) {
      let oldValue = null;
      try {
        const info = municipalityInfo[municipality];
        if (!info) {
          showToast(`Ëá™Ê≤ª‰ΩìÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${municipality}`, 'error');
          return;
        }

        oldValue = info[field];
        info[field] = newValue;
        indexData.municipality_info = municipalityInfo;

        const labelText = displayLabel || field;
        
        // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠ò„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°(PHP„Çµ„Éº„Éê„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà)
        try {
          const response = await fetch('save-edit.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              municipality: municipality,
              field: field,
              value: newValue
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              updateBadgeDisplay(badgeElement, field, newValue);
              showToast(`${municipality}„ÅÆ${labelText}„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü („Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó: ${result.backup})`, 'success');
              return;
            }
          }
        } catch (fetchError) {
          console.log('PHP„Çµ„Éº„Éê„Éº„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊ©üËÉΩ„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }

        updateBadgeDisplay(badgeElement, field, newValue);

        showToast(
          `${municipality}„ÅÆ${labelText}„Çí„Äå${oldValue ?? 'Êú™Ë®≠ÂÆö'}„Äç„Åã„Çâ„Äå${newValue}„Äç„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ\n„ÄåJSON„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Äç„Éú„Çø„É≥„Åß‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`,
          'warning'
        );

        showDownloadButton();

      } catch (error) {
        console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
        if (municipalityInfo[municipality]) {
          municipalityInfo[municipality][field] = oldValue;
        }
        showToast('Á∑®ÈõÜ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
      }
    }

    // „Éê„ÉÉ„Ç∏Ë°®Á§∫„ÇíÊõ¥Êñ∞
    function updateBadgeDisplay(badgeElement, field, newValue) {
      const displayText = field === 'strictness_absolute' ? `Âé≥Ê†ºÂ∫¶: ${newValue}` : newValue;
      badgeElement.textContent = displayText;
      
      if (field === 'strictness_absolute') {
        badgeElement.className = badgeElement.className.replace(/very-strict|strict|standard|lenient/g, '');
        badgeElement.className += ' ' + getStrictnessClass(newValue);
      }
    }

    // JSON„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥„ÇíË°®Á§∫
    function showDownloadButton() {
      if (document.getElementById('download-json-btn')) return; // Êó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà
      
      const btn = document.createElement('button');
      btn.id = 'download-json-btn';
      btn.innerHTML = 'üíæ JSON„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ';
      btn.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        transition: all 0.3s;
        animation: pulse 2s infinite;
      `;
      
      btn.addEventListener('mouseover', () => {
        btn.style.transform = 'scale(1.05)';
        btn.style.boxShadow = '0 8px 20px rgba(102, 126, 234, 0.4)';
      });
      
      btn.addEventListener('mouseout', () => {
        btn.style.transform = 'scale(1)';
        btn.style.boxShadow = 'var(--shadow-lg)';
      });
      
      btn.addEventListener('click', downloadJSON);
      
      document.body.appendChild(btn);
      
      // „Éë„É´„Çπ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
      if (!document.querySelector('#pulse-animation')) {
        const style = document.createElement('style');
        style.id = 'pulse-animation';
        style.textContent = `
          @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(102, 126, 234, 0.6); }
          }
        `;
        document.head.appendChild(style);
      }
    }

    // JSON„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    function downloadJSON() {
      // index.json„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„Çã
      const jsonStr = JSON.stringify(indexData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `index_edited_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('index.json„Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü„ÄÇÂÖÉ„ÅÆ„Éï„Ç°„Ç§„É´„Å®ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'success');
    }

    // „Éà„Éº„Çπ„ÉàÈÄöÁü•„ÇíË°®Á§∫
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 20px;
        background-color: ${type === 'success' ? 'var(--color-success)' : 
                          type === 'error' ? 'var(--color-error)' : 
                          'var(--color-info)'};
        color: white;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        max-width: 400px;
        font-size: 14px;
      `;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÂãïÁöÑ„Å´ËøΩÂä†
    if (!document.querySelector('#toast-animations')) {
      const style = document.createElement('style');
      style.id = 'toast-animations';
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(400px);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(400px);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    }

    // „ÉÜ„Ç≠„Çπ„Éà„Çí„Éè„Ç§„É©„Ç§„Éà
    function highlightText(text, codes) {
      if (!text || codes.length === 0) {
        return escapeHtml(text || '');
      }
      
      // „Ç≥„Éº„Éá„Ç£„É≥„Ç∞„É´„Éº„É´ v3.5 „Å´Âü∫„Å•„ÅèÂåÖÊã¨ÁöÑ„Å™„Ç≠„Éº„ÉØ„Éº„Éâ„Éû„ÉÉ„Éî„É≥„Ç∞
      const keywords = {
        '*CLAUSE_EXPLANATION': [
          'Ë™¨Êòé‰ºö', 'Ë™¨Êòé„ÅÆÂ†¥', 'Ë™¨Êòé', 'Âë®Áü•', '‰ΩèÊ∞ëË™¨Êòé', 'ËøëÈö£Ë™¨Êòé', 'Âú∞Âüü‰ΩèÊ∞ëË™¨Êòé'
        ],
        '*CLAUSE_NEGATIVE_PERMISSION_CONSENT': [
          '‰∏çË®±ÂèØ', 'Ë®±ÂèØ„Åó„Å™„ÅÑ', 'ÊâøË™ç„Åó„Å™„ÅÑ', 'ÂêåÊÑè„Åó„Å™„ÅÑ', 'Ë™çÂèØ„Åó„Å™„ÅÑ'
        ],
        '*CLAUSE_POSITIVE_PERMISSION_CONSENT': [
          'Â∏ÇÈï∑', 'ÊùëÈï∑', 'Áî∫Èï∑', 'Ë®±ÂèØ', 'ÊâøË™ç', 'ÂêåÊÑè', 'Ë™çÂèØ'
        ],
        '*CLAUSE_PENALTY_Lv2': [
          'ÁΩ∞Ââá', 'ÁΩ∞Èáë', 'ÈÅéÊñô'
        ],
        '*CLAUSE_PENALTY_Lv1': [
          'ÂÖ¨Ë°®', 'Ê∞èÂêçÂÖ¨Ë°®', 'ÂãßÂëä', 'ÂëΩ‰ª§', 'Êé™ÁΩÆÂëΩ‰ª§', 'Êé™ÁΩÆ„ÇíÂëΩ„Åö„Çã'
        ],
        '*CLAUSE_RESTRICTED_ZONE': [
          'ÂúüÁ†ÇÁÅΩÂÆ≥ÁâπÂà•Ë≠¶ÊàíÂå∫Âüü', 'ÂúüÁ†ÇÁÅΩÂÆ≥Ë≠¶ÊàíÂå∫Âüü', '‰øùÂÆâÊûó', 'Â∏ÇË°óÂåñË™øÊï¥Âå∫Âüü',
          'ÊñáÂåñË≤°', 'Ê≤≥Â∑ù‰øùÂÖ®Âå∫Âüü', 'Êµ∑Â≤∏‰øùÂÖ®Âå∫Âüü', 'ÊÄ•ÂÇæÊñúÂú∞Â¥©Â£äÂç±Èô∫Âå∫Âüü', 'Âú∞„Åô„Åπ„ÇäÈò≤Ê≠¢Âå∫Âüü'
        ],
        '*CLAUSE_ZONE_Lv1': [
          'ÊäëÂà∂Âå∫Âüü', 'Âà∂ÈôêÂå∫Âüü', '‰øùÂÖ®Âå∫Âüü', 'ÊäëÂà∂Âú∞Âå∫', 'Âà∂ÈôêÂú∞Âå∫', '‰øùÂÖ®Âú∞Âå∫'
        ],
        '*CLAUSE_ZONE_Lv2': [
          'Á¶ÅÊ≠¢Âå∫Âüü', 'Á¶ÅÊ≠¢Âú∞Âå∫'
        ],
        '*CLAUSE_ENVIRONMENT': [
          'ÊøÅÊ∞¥', '‰ΩéÂë®Ê≥¢Èü≥', 'ÂèçÂ∞Ñ', '‰ΩéÂèçÂ∞Ñ', 'ÊôØË¶≥', 'ÁîüÊÖãÁ≥ª', 'È®íÈü≥', 'ÊåØÂãï',
          'ÂúüÁ†ÇÊµÅÂá∫', '‰ºêÊé°', '‰øùÂÖ®', '‰øùË≠∑', 'Ëá™ÁÑ∂Áí∞Â¢É', 'Ê∞¥Ë≥™', 'ÂúüÂ£å', 'ÂãïÊ§çÁâ©'
        ],
        '*CLAUSE_DOC_REQUIREMENTS': [
          'Áî≥Ë´ãÊõ∏', 'Áî≥Ë´ãÊõ∏È°û', 'Áî≥Ë´ãÂõ≥', 'Áî≥Ë´ãÂõ≥Èù¢', 'Áî≥Ë´ãË®àÁîªÊõ∏',
          'Â±äÂá∫Êõ∏', 'Â±äÂá∫Êõ∏È°û', 'Â±äÂá∫Âõ≥', 'Â±äÂá∫Âõ≥Èù¢', 'Â±äÂá∫Ë®àÁîªÊõ∏',
          'ÊèêÂá∫Êõ∏', 'ÊèêÂá∫Êõ∏È°û', 'ÊèêÂá∫Âõ≥', 'ÊèêÂá∫Âõ≥Èù¢', 'ÊèêÂá∫Ë®àÁîªÊõ∏',
          'Ê∑ª‰ªòÊõ∏È°û', 'Ê∑ª‰ªòÂõ≥', 'Ê∑ª‰ªòÂõ≥Èù¢'
        ],
        '*CLAUSE_DRAWINGS': [
          '‰ΩçÁΩÆÂõ≥', 'ÁèæÊ≥ÅÂπ≥Èù¢Âõ≥', 'Âπ≥Èù¢Âõ≥', 'Êñ≠Èù¢Âõ≥', 'ÊßãÈÄ†Âõ≥',
          'ÈÄ†ÊàêË®àÁîªÂπ≥Èù¢Âõ≥', 'ÊéíÊ∞¥Ë®àÁîªÂπ≥Èù¢Âõ≥', 'ÂúüÂú∞Âà©Áî®Ë®àÁîªÂπ≥Èù¢Âõ≥', 'ÂÖ¨Âõ≥', 'ÁèæÊ≥ÅÂÜôÁúü'
        ],
        '*CLAUSE_DECOMMISSION_MAINTENANCE': [
          'Êí§Âéª', 'ÂéüÁä∂ÂõûÂæ©', 'Á∂≠ÊåÅÁÆ°ÁêÜ', '‰øùÂÆà', 'ÁÇπÊ§ú', 'Ë£ú‰øÆ'
        ],
        '*CLAUSE_SIGNAGE': [
          'Ê®ôË≠ò', 'Ë®≠ÁΩÆ', 'Ë°®Á§∫', 'Êé≤Âá∫', 'Êé≤Á§∫'
        ],
        '*CLAUSE_PUBLICITY': [
          'Á∏¶Ë¶ß', 'ÂÖ¨Âëä', 'ÂÖ¨Á§∫', 'ÂëäÁ§∫', 'ÊÑèË¶ãÂÖ¨Âãü', '„Éë„Éñ„É™„ÉÉ„ÇØ„Ç≥„É°„É≥„Éà'
        ],
        '*CLAUSE_HEARING': [
          'ÂÖ¨ËÅ¥‰ºö', 'ÊÑèË¶ãËÅ¥Âèñ', 'ËÅ¥ËÅû'
        ],
        '*CLAUSE_FINANCE': [
          'Ë≥áÈáëË®àÁîª', '‰øùË®ºÈáë', 'ÊãÖ‰øù', '‰øùÈô∫', 'Ë≤†ÊãÖÈáë'
        ],
        '*CLAUSE_EQUIPMENT_NOISE': [
          '„Éë„ÉØ„Éº„Ç≥„É≥„Éá„Ç£„Ç∑„Éß„Éä„Éº', '„Ç§„É≥„Éê„Éº„Çø', 'PCS', 'Ê©üÂô®È®íÈü≥', 'Ê©üÂô®‰ΩéÂë®Ê≥¢Èü≥'
        ],
        '*MODAL_PROHIBIT': [
          '„Åó„Å¶„ÅØ„Å™„Çâ„Å™„ÅÑ', 'Á¶ÅÊ≠¢„Åô„Çã', '„Å¶„ÅØ„Å™„Çâ„Å™„ÅÑ'
        ],
        '*MODAL_MUST': [
          '„Åó„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ', '„Åó„Å™„Åë„Çå„Å∞„Å™„Çâ„Åö', '„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ'
        ],
        '*MODAL_SHOULD': [
          'Âä™„ÇÅ„Çã', 'ÈÖçÊÖÆ„Åô„Çã', 'Êúõ„Åæ„Åó„ÅÑ', 'Âä™„ÇÅ„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ'
        ],
        '*GUARD_EXCEPTION_TADASHI': [
          '„Åü„Å†„Åó', '‰ΩÜ„Åó', '„Åü„Å†„ÅóÂ†¥Âêà', '‰ΩÜ„ÅóÂ†¥Âêà'
        ],
        '*PROCEDURE_NOTICE_MUNICIPARITY': [
          'ÈÄöÁü•', 'ÊåáÁ§∫', 'ÂëΩ„Åò„Çã', 'Ê±Ç„ÇÅ„Çã'
        ],
        '*PROCEDURE_CONSULTAION': [
          'ÂçîË≠∞'
        ],
        '*PROCEDURE_NOTICE_OPERATOR': [
          'Â†±Âëä', 'ÈÄ£Áµ°', 'Â±äÂá∫', 'Â±ä„ÅëÂá∫„Çã'
        ],
        '*PROCEDURE_TIMING': [
          '‰∫ãÂâç', 'ÁùÄÊâãÂâç', 'Â∑•‰∫ãÁùÄÊâãÂâç', 'ÂÆüÊñΩÂâç', '„Åæ„Åß„Å´', 'ÊúüÊó•', 'ÊúüÈôê'
        ],
        '*STAKEHOLDER_RESIDENTS': [
          'ËøëÈö£‰ΩèÊ∞ë', 'Èñ¢‰øÇ‰ΩèÊ∞ë', 'Âú∞Âüü‰ΩèÊ∞ë', '‰ΩèÊ∞ë', 'Âë®Ëæ∫Èñ¢‰øÇËÄÖ',
          'Èö£Êé•ÂúüÂú∞ÊâÄÊúâËÄÖ', 'Èö£Êé•ÂúüÂú∞ÊâÄÊúâËÄÖÁ≠â'
        ],
        '*CLAUSE_STAKEHOLDER_CONFIRMATION': [
          '‰ΩèÊ∞ëÂêåÊÑè', 'ËøëÈö£ÂêåÊÑè', 'Èñ¢‰øÇ‰ΩèÊ∞ëÂêåÊÑè', 'Âú∞Âüü‰ΩèÊ∞ëÂêåÊÑè',
          '‰ΩèÊ∞ëÊâøË™ç', '‰ΩèÊ∞ëË®±ÂèØ'
        ],
        '*STAKEHOLDER_LANDOWNER': [
          'ÂúüÂú∞ÊâÄÊúâËÄÖ', 'Âú∞Ê®©ËÄÖ', 'Èñ¢‰øÇÊ®©Âà©ËÄÖ'
        ],
        '*GEO_REFERENCES': [
          'Ë∞∑', 'Ê≤¢', 'ÊÄ•ÊñúÈù¢', 'Ê∞¥Ë∑Ø', 'Ê≤≥Â∑ù', '„Åü„ÇÅÊ±†', 'Ë™øÊï¥Ê±†', 'Â±±ËÖπ', 'Â∞æÊ†π', 'Ë∞∑Á≠ã'
        ]
      };
      
      let highlightedText = escapeHtml(text);
      const allKeywords = [];
      
      codes.forEach(code => {
        if (keywords[code]) {
          allKeywords.push(...keywords[code]);
        }
      });
      
      const uniqueKeywords = [...new Set(allKeywords)];
      uniqueKeywords.sort((a, b) => b.length - a.length);
      
      uniqueKeywords.forEach(keyword => {
        const regex = new RegExp(`(${escapeRegExp(keyword)})`, 'g');
        highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
      });
      
      return highlightedText;
    }

    // HTML„Ç®„Çπ„Ç±„Éº„Éó
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Ê≠£Ë¶èË°®ÁèæÁî®„ÅÆ„Ç®„Çπ„Ç±„Éº„Éó
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // „Çø„ÉñÂàá„ÇäÊõø„Åà
    function setupTabSwitching() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.getAttribute('data-view');
          switchView(view);
          
          // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çø„Éñ„ÇíÊõ¥Êñ∞
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
    }

    function switchView(view) {
      currentView = view;
      
      document.querySelectorAll('.view-container').forEach(container => {
        container.classList.remove('active');
      });
      
      if (view === 'text') {
        document.getElementById('textView').classList.add('active');
      } else if (view === 'dashboard') {
        document.getElementById('dashboardView').classList.add('active');
        initializeDashboard();
      }
    }

    // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÇíÂàùÊúüÂåñ
    function initializeDashboard() {
      renderOverallStats();
      renderCharts();
    }

    function renderOverallStats() {
      const container = document.getElementById('overallStats');
      container.innerHTML = '';
      
      const stats = [
        { label: 'Ëá™Ê≤ª‰ΩìÊï∞', value: municipalities.length },
        { label: 'ÊÆµËêΩÁ∑èÊï∞', value: statistics['Á∑èÊÆµËêΩÊï∞'] },
        { label: '„Ç≥„Éº„Éá„Ç£„É≥„Ç∞Á®ÆÈ°û', value: codingTypes.length },
        { label: 'Âπ≥ÂùáÂé≥Ê†ºÂ∫¶„Çπ„Ç≥„Ç¢', value: statistics['Âé≥Ê†ºÂ∫¶„Çπ„Ç≥„Ç¢Áµ±Ë®à']['Âπ≥Âùá'].toFixed(1) },
        { label: 'Âπ≥Âùá‰ΩèÊ∞ëÂèÇÂä†„Çπ„Ç≥„Ç¢', value: statistics['‰ΩèÊ∞ëÂèÇÂä†„Çπ„Ç≥„Ç¢Áµ±Ë®à']['Âπ≥Âùá'].toFixed(1) },
        { label: 'Âπ≥ÂùáÊâãÁ∂ö„Åç„Çπ„Ç≥„Ç¢', value: statistics['ÊâãÁ∂ö„Åç„Çπ„Ç≥„Ç¢Áµ±Ë®à']['Âπ≥Âùá'].toFixed(1) }
      ];
      
      stats.forEach(stat => {
        const card = document.createElement('div');
        card.className = 'stat-card';
        card.innerHTML = `
          <div class="stat-value">${stat.value}</div>
          <div class="stat-label">${stat.label}</div>
        `;
        container.appendChild(card);
      });
    }

    function renderCharts() {
      // Êó¢Â≠ò„ÅÆ„ÉÅ„É£„Éº„Éà„ÇíÁ†¥Ê£Ñ
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });
      charts = {};
      
      // Ë¶èÂà∂„Çø„Ç§„ÉóÂàÜÂ∏É
      charts.regulation = new Chart(document.getElementById('regulationChart'), {
        type: 'pie',
        data: {
          labels: Object.keys(statistics['Ë¶èÂà∂„Çø„Ç§„ÉóÂàÜÂ∏É']),
          datasets: [{
            data: Object.values(statistics['Ë¶èÂà∂„Çø„Ç§„ÉóÂàÜÂ∏É']),
            backgroundColor: [
              'rgba(59, 130, 246, 0.7)',
              'rgba(245, 158, 11, 0.7)',
              'rgba(34, 197, 94, 0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Ë¶èÂà∂„Çø„Ç§„ÉóÂàÜÂ∏É'
            },
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      
      // Âå∫ÂüüÈ°ûÂûãÂàÜÂ∏É
      charts.zone = new Chart(document.getElementById('zoneChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(statistics['Âå∫ÂüüÈ°ûÂûãÂàÜÂ∏É']),
          datasets: [{
            label: 'Ëá™Ê≤ª‰ΩìÊï∞',
            data: Object.values(statistics['Âå∫ÂüüÈ°ûÂûãÂàÜÂ∏É']),
            backgroundColor: 'rgba(147, 51, 234, 0.7)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Âå∫ÂüüÈ°ûÂûãÂàÜÂ∏É'
            },
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Âé≥Ê†ºÂ∫¶ÂàÜÂ∏É
      charts.strictness = new Chart(document.getElementById('strictnessChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(statistics['Âé≥Ê†ºÂ∫¶_Áµ∂ÂØæÂàÜÂ∏É']),
          datasets: [{
            data: Object.values(statistics['Âé≥Ê†ºÂ∫¶_Áµ∂ÂØæÂàÜÂ∏É']),
            backgroundColor: [
              'rgba(220, 38, 38, 0.7)',
              'rgba(234, 88, 12, 0.7)',
              'rgba(250, 204, 21, 0.7)',
              'rgba(34, 197, 94, 0.7)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Âé≥Ê†ºÂ∫¶„É¨„Éô„É´ÂàÜÂ∏É'
            },
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      
      // „Éó„É≠„Çª„ÇπÈáçË¶ñÂ∫¶ÂàÜÂ∏É
      charts.process = new Chart(document.getElementById('processChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(statistics['„Éó„É≠„Çª„ÇπÈáçË¶ñÂ∫¶ÂàÜÂ∏É']),
          datasets: [{
            label: 'Ëá™Ê≤ª‰ΩìÊï∞',
            data: Object.values(statistics['„Éó„É≠„Çª„ÇπÈáçË¶ñÂ∫¶ÂàÜÂ∏É']),
            backgroundColor: 'rgba(249, 115, 22, 0.7)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: '„Éó„É≠„Çª„ÇπÈáçË¶ñÂ∫¶ÂàÜÂ∏É'
            },
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // Êï£Â∏ÉÂõ≥: Âé≥Ê†ºÂ∫¶ vs ‰ΩèÊ∞ëÂèÇÂä†
      const scatterData1 = municipalities.map(mun => {
        const info = municipalityInfo[mun];
        return {
          x: info['Âé≥Ê†ºÂ∫¶„Çπ„Ç≥„Ç¢'],
          y: info['‰ΩèÊ∞ëÂèÇÂä†„Çπ„Ç≥„Ç¢'],
          label: mun
        };
      });
      
      charts.scatterStrictnessResident = new Chart(document.getElementById('scatterStrictnessResident'), {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Ëá™Ê≤ª‰Ωì',
            data: scatterData1,
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Âé≥Ê†ºÂ∫¶„Çπ„Ç≥„Ç¢ vs ‰ΩèÊ∞ëÂèÇÂä†„Çπ„Ç≥„Ç¢'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.raw.label + ': (' + 
                    context.raw.x.toFixed(1) + ', ' + 
                    context.raw.y.toFixed(1) + ')';
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Âé≥Ê†ºÂ∫¶„Çπ„Ç≥„Ç¢'
              }
            },
            y: {
              title: {
                display: true,
                text: '‰ΩèÊ∞ëÂèÇÂä†„Çπ„Ç≥„Ç¢'
              }
            }
          }
        }
      });
      
      // Êï£Â∏ÉÂõ≥: Âé≥Ê†ºÂ∫¶ vs ÊâãÁ∂ö„Åç
      const scatterData2 = municipalities.map(mun => {
        const info = municipalityInfo[mun];
        return {
          x: info['Âé≥Ê†ºÂ∫¶„Çπ„Ç≥„Ç¢'],
          y: info['ÊâãÁ∂ö„Åç„Çπ„Ç≥„Ç¢'],
          label: mun
        };
      });
      
      charts.scatterStrictnessProcedure = new Chart(document.getElementById('scatterStrictnessProcedure'), {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Ëá™Ê≤ª‰Ωì',
            data: scatterData2,
            backgroundColor: 'rgba(245, 158, 11, 0.5)',
            borderColor: 'rgba(245, 158, 11, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Âé≥Ê†ºÂ∫¶„Çπ„Ç≥„Ç¢ vs ÊâãÁ∂ö„Åç„Çπ„Ç≥„Ç¢'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.raw.label + ': (' + 
                    context.raw.x.toFixed(1) + ', ' + 
                    context.raw.y.toFixed(1) + ')';
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Âé≥Ê†ºÂ∫¶„Çπ„Ç≥„Ç¢'
              }
            },
            y: {
              title: {
                display: true,
                text: 'ÊâãÁ∂ö„Åç„Çπ„Ç≥„Ç¢'
              }
            }
          }
        }
      });
    }

    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
    function showLoading(message = '„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...') {
      const container = document.getElementById('paragraphs');
      container.innerHTML = `<div class="loading">${escapeHtml(message)}</div>`;
    }

    // „Ç®„É©„ÉºË°®Á§∫
    function showError(message) {
      const container = document.getElementById('paragraphs');
      container.innerHTML = `<div class="error">„Ç®„É©„Éº: ${escapeHtml(message)}</div>`;
    }

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
    init();
  </script>
</body>
</html>
